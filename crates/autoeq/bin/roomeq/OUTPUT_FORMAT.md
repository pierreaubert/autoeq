# RoomEQ Output DSP Chain Format

This document describes the JSON output format generated by the `roomeq` command-line tool. The output is compatible with the AudioEngine plugin system.

**JSON Schema:** [`output_schema.json`](./output_schema.json)

To validate output against the schema:
```bash
# Using ajv-cli
npx ajv validate -s output_schema.json -d dsp_chain.json

# Using check-jsonschema
check-jsonschema --schemafile output_schema.json dsp_chain.json
```

## Root Structure

```json
{
  "version": "1.0.0",
  "channels": { ... },
  "metadata": { ... }
}
```

### Top-Level Fields

| Field | Type | Description |
|-------|------|-------------|
| `version` | string | Output format version |
| `channels` | object | Map of channel names to DSP chains |
| `metadata` | object | Optimization metadata (optional) |

---

## Channel DSP Chain

Each channel contains an ordered list of plugins that process audio in sequence.

```json
{
  "channels": {
    "left": {
      "channel": "left",
      "plugins": [ ... ],
      "drivers": [ ... ]
    }
  }
}
```

**ChannelDspChain Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `channel` | string | Channel name |
| `plugins` | array | Ordered list of plugin configurations |
| `drivers` | array or null | Per-driver DSP chains (for multi-driver speakers) |

---

## Plugin Types

### Gain Plugin

Applies gain adjustment and optional polarity inversion.

```json
{
  "plugin_type": "gain",
  "parameters": {
    "gain_db": -2.5,
    "invert": false
  }
}
```

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `gain_db` | number (dB) | **Yes** | Gain adjustment (positive = boost, negative = cut) |
| `invert` | boolean | No | Polarity inversion (default: false) |

### EQ Plugin

Parametric EQ with multiple filter bands.

```json
{
  "plugin_type": "eq",
  "parameters": {
    "filters": [
      {
        "filter_type": "peak",
        "freq": 1000.0,
        "q": 1.5,
        "db_gain": 3.0
      },
      {
        "filter_type": "lowshelf",
        "freq": 100.0,
        "q": 0.707,
        "db_gain": 2.5
      },
      {
        "filter_type": "highshelf",
        "freq": 10000.0,
        "q": 0.707,
        "db_gain": -1.5
      }
    ]
  }
}
```

**Filter Object Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `filter_type` | string | Filter type: `"peak"`, `"lowshelf"`, or `"highshelf"` |
| `freq` | number (Hz) | Center/corner frequency |
| `q` | number | Q factor (higher = narrower bandwidth) |
| `db_gain` | number (dB) | Gain adjustment |

### Crossover Plugin

Frequency band splitting for multi-driver systems.

```json
{
  "plugin_type": "crossover",
  "parameters": {
    "type": "LR24",
    "frequency": 2500.0,
    "output": "low"
  }
}
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `type` | string | Crossover type: `"LR24"`, `"LR48"`, `"Butterworth12"`, `"Butterworth24"` |
| `frequency` | number (Hz) | Crossover frequency |
| `output` | string | Band selection: `"low"` (lowpass) or `"high"` (highpass) |

### Delay Plugin

Time delay for driver alignment.

```json
{
  "plugin_type": "delay",
  "parameters": {
    "delay_ms": 2.5
  }
}
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `delay_ms` | number (ms) | Delay amount in milliseconds |

### Convolution Plugin

FIR filter via convolution with impulse response.

```json
{
  "plugin_type": "convolution",
  "parameters": {
    "ir_file": "filters/left_fir.wav"
  }
}
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `ir_file` | string | Path to WAV file containing impulse response |

---

## Per-Driver DSP Chains

For multi-driver speakers, the output includes individual processing chains for each driver.

```json
{
  "drivers": [
    {
      "name": "woofer",
      "index": 0,
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": { "gain_db": 1.5 }
        },
        {
          "plugin_type": "delay",
          "parameters": { "delay_ms": 0.5 }
        },
        {
          "plugin_type": "crossover",
          "parameters": {
            "type": "LR24",
            "frequency": 2500.0,
            "output": "low"
          }
        }
      ]
    },
    {
      "name": "tweeter",
      "index": 1,
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": { "gain_db": -0.5 }
        },
        {
          "plugin_type": "crossover",
          "parameters": {
            "type": "LR24",
            "frequency": 2500.0,
            "output": "high"
          }
        }
      ]
    }
  ]
}
```

**DriverDspChain Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Driver name (e.g., `"woofer"`, `"tweeter"`, `"midrange"`) |
| `index` | integer | Driver index (0 = lowest frequency driver) |
| `plugins` | array | Plugins for this driver |

### Automatic Driver Naming

Driver names are automatically generated based on the number of drivers:

| Drivers | Index 0 | Index 1 | Index 2 | Index 3 |
|---------|---------|---------|---------|---------|
| 2-way | woofer | tweeter | - | - |
| 3-way | woofer | midrange | tweeter | - |
| 4-way | woofer | lower_midrange | upper_midrange | tweeter |

For subwoofer groups, names are formatted as `{group_name}_{index+1}` (e.g., `"sub_1"`, `"sub_2"`).

---

## Optimization Metadata

Information about the optimization process.

```json
{
  "metadata": {
    "pre_score": 2.451,
    "post_score": 0.125,
    "algorithm": "cobyla",
    "iterations": 10000,
    "timestamp": "2025-01-15T12:34:56Z"
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `pre_score` | number | Loss function value before optimization |
| `post_score` | number | Loss function value after optimization (lower is better) |
| `algorithm` | string | Algorithm used for optimization |
| `iterations` | integer | Maximum iterations configured |
| `timestamp` | string | ISO 8601 timestamp of optimization |

---

## Complete Output Examples

### Example 1: Simple Stereo EQ

Output for a basic stereo system with EQ filters only.

```json
{
  "version": "1.0.0",
  "channels": {
    "left": {
      "channel": "left",
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": {
            "gain_db": -2.3
          }
        },
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              {
                "filter_type": "peak",
                "freq": 63.0,
                "q": 2.5,
                "db_gain": -4.2
              },
              {
                "filter_type": "peak",
                "freq": 250.0,
                "q": 1.8,
                "db_gain": 2.1
              },
              {
                "filter_type": "peak",
                "freq": 3150.0,
                "q": 3.2,
                "db_gain": -3.5
              }
            ]
          }
        }
      ],
      "drivers": null
    },
    "right": {
      "channel": "right",
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": {
            "gain_db": -1.8
          }
        },
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              {
                "filter_type": "peak",
                "freq": 80.0,
                "q": 2.0,
                "db_gain": -3.8
              },
              {
                "filter_type": "peak",
                "freq": 200.0,
                "q": 1.5,
                "db_gain": 1.9
              },
              {
                "filter_type": "peak",
                "freq": 4000.0,
                "q": 2.8,
                "db_gain": -2.7
              }
            ]
          }
        }
      ],
      "drivers": null
    }
  },
  "metadata": {
    "pre_score": 3.24,
    "post_score": 0.45,
    "algorithm": "cobyla",
    "iterations": 5000,
    "timestamp": "2025-01-15T10:30:00Z"
  }
}
```

### Example 2: 2-Way Active Speaker

Output for a 2-way speaker with crossover and per-driver processing.

```json
{
  "version": "1.0.0",
  "channels": {
    "left": {
      "channel": "left",
      "plugins": [
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              {
                "filter_type": "peak",
                "freq": 1000.0,
                "q": 1.5,
                "db_gain": -2.0
              },
              {
                "filter_type": "peak",
                "freq": 5000.0,
                "q": 2.0,
                "db_gain": 1.5
              }
            ]
          }
        }
      ],
      "drivers": [
        {
          "name": "woofer",
          "index": 0,
          "plugins": [
            {
              "plugin_type": "gain",
              "parameters": {
                "gain_db": 0.0
              }
            },
            {
              "plugin_type": "crossover",
              "parameters": {
                "type": "LR24",
                "frequency": 2200.0,
                "output": "low"
              }
            }
          ]
        },
        {
          "name": "tweeter",
          "index": 1,
          "plugins": [
            {
              "plugin_type": "gain",
              "parameters": {
                "gain_db": -1.5
              }
            },
            {
              "plugin_type": "delay",
              "parameters": {
                "delay_ms": 0.15
              }
            },
            {
              "plugin_type": "crossover",
              "parameters": {
                "type": "LR24",
                "frequency": 2200.0,
                "output": "high"
              }
            }
          ]
        }
      ]
    }
  },
  "metadata": {
    "pre_score": 5.12,
    "post_score": 0.28,
    "algorithm": "cobyla",
    "iterations": 15000,
    "timestamp": "2025-01-15T11:00:00Z"
  }
}
```

### Example 3: 3-Way Speaker

Output for a 3-way speaker with woofer, midrange, and tweeter.

```json
{
  "version": "1.0.0",
  "channels": {
    "left": {
      "channel": "left",
      "plugins": [
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              {
                "filter_type": "peak",
                "freq": 100.0,
                "q": 1.2,
                "db_gain": -3.0
              }
            ]
          }
        }
      ],
      "drivers": [
        {
          "name": "woofer",
          "index": 0,
          "plugins": [
            {
              "plugin_type": "gain",
              "parameters": {
                "gain_db": 1.2
              }
            },
            {
              "plugin_type": "crossover",
              "parameters": {
                "type": "LR24",
                "frequency": 500.0,
                "output": "low"
              }
            }
          ]
        },
        {
          "name": "midrange",
          "index": 1,
          "plugins": [
            {
              "plugin_type": "gain",
              "parameters": {
                "gain_db": 0.0
              }
            },
            {
              "plugin_type": "crossover",
              "parameters": {
                "type": "LR24",
                "frequency": 500.0,
                "output": "high"
              }
            },
            {
              "plugin_type": "crossover",
              "parameters": {
                "type": "LR24",
                "frequency": 3500.0,
                "output": "low"
              }
            }
          ]
        },
        {
          "name": "tweeter",
          "index": 2,
          "plugins": [
            {
              "plugin_type": "gain",
              "parameters": {
                "gain_db": -2.0
              }
            },
            {
              "plugin_type": "delay",
              "parameters": {
                "delay_ms": 0.25
              }
            },
            {
              "plugin_type": "crossover",
              "parameters": {
                "type": "LR24",
                "frequency": 3500.0,
                "output": "high"
              }
            }
          ]
        }
      ]
    }
  },
  "metadata": {
    "pre_score": 6.85,
    "post_score": 0.35,
    "algorithm": "cobyla",
    "iterations": 20000,
    "timestamp": "2025-01-15T12:00:00Z"
  }
}
```

### Example 4: Multiple Subwoofers

Output for a multi-subwoofer system with optimized gains and delays.

```json
{
  "version": "1.0.0",
  "channels": {
    "lfe": {
      "channel": "lfe",
      "plugins": [
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              {
                "filter_type": "peak",
                "freq": 40.0,
                "q": 3.0,
                "db_gain": -5.5
              },
              {
                "filter_type": "peak",
                "freq": 80.0,
                "q": 2.5,
                "db_gain": 2.0
              }
            ]
          }
        }
      ],
      "drivers": [
        {
          "name": "sub_1",
          "index": 0,
          "plugins": [
            {
              "plugin_type": "gain",
              "parameters": {
                "gain_db": 0.0
              }
            }
          ]
        },
        {
          "name": "sub_2",
          "index": 1,
          "plugins": [
            {
              "plugin_type": "gain",
              "parameters": {
                "gain_db": -2.5
              }
            },
            {
              "plugin_type": "delay",
              "parameters": {
                "delay_ms": 3.2
              }
            }
          ]
        },
        {
          "name": "sub_3",
          "index": 2,
          "plugins": [
            {
              "plugin_type": "gain",
              "parameters": {
                "gain_db": -1.8
              }
            },
            {
              "plugin_type": "delay",
              "parameters": {
                "delay_ms": 1.5
              }
            }
          ]
        },
        {
          "name": "sub_4",
          "index": 3,
          "plugins": [
            {
              "plugin_type": "gain",
              "parameters": {
                "gain_db": -3.0
              }
            },
            {
              "plugin_type": "delay",
              "parameters": {
                "delay_ms": 4.8
              }
            }
          ]
        }
      ]
    }
  },
  "metadata": {
    "pre_score": 8.5,
    "post_score": 0.6,
    "algorithm": "cobyla",
    "iterations": 10000,
    "timestamp": "2025-01-15T13:00:00Z"
  }
}
```

### Example 5: Double Bass Array (DBA)

Output for a DBA system with front and rear arrays.

```json
{
  "version": "1.0.0",
  "channels": {
    "lfe": {
      "channel": "lfe",
      "plugins": [
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              {
                "filter_type": "peak",
                "freq": 35.0,
                "q": 4.0,
                "db_gain": -3.0
              }
            ]
          }
        }
      ],
      "drivers": [
        {
          "name": "Front Array",
          "index": 0,
          "plugins": [
            {
              "plugin_type": "gain",
              "parameters": {
                "gain_db": 0.0
              }
            }
          ]
        },
        {
          "name": "Rear Array",
          "index": 1,
          "plugins": [
            {
              "plugin_type": "gain",
              "parameters": {
                "gain_db": -1.5,
                "invert": true
              }
            },
            {
              "plugin_type": "delay",
              "parameters": {
                "delay_ms": 8.5
              }
            }
          ]
        }
      ]
    }
  },
  "metadata": {
    "pre_score": 12.0,
    "post_score": 0.8,
    "algorithm": "cobyla",
    "iterations": 15000,
    "timestamp": "2025-01-15T14:00:00Z"
  }
}
```

### Example 6: FIR Convolution Output

Output when using FIR mode optimization.

```json
{
  "version": "1.0.0",
  "channels": {
    "left": {
      "channel": "left",
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": {
            "gain_db": -3.0
          }
        },
        {
          "plugin_type": "convolution",
          "parameters": {
            "ir_file": "output/left_fir.wav"
          }
        }
      ],
      "drivers": null
    },
    "right": {
      "channel": "right",
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": {
            "gain_db": -2.8
          }
        },
        {
          "plugin_type": "convolution",
          "parameters": {
            "ir_file": "output/right_fir.wav"
          }
        }
      ],
      "drivers": null
    }
  },
  "metadata": {
    "pre_score": 4.2,
    "post_score": 0.15,
    "algorithm": "cobyla",
    "iterations": 5000,
    "timestamp": "2025-01-15T15:00:00Z"
  }
}
```

### Example 7: Complete Home Theater System

Output for a 5.1 home theater system.

```json
{
  "version": "1.0.0",
  "channels": {
    "left": {
      "channel": "left",
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": { "gain_db": -1.5 }
        },
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              { "filter_type": "peak", "freq": 80.0, "q": 2.0, "db_gain": -4.0 },
              { "filter_type": "peak", "freq": 3000.0, "q": 1.5, "db_gain": 2.0 }
            ]
          }
        }
      ],
      "drivers": null
    },
    "center": {
      "channel": "center",
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": { "gain_db": 0.5 }
        },
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              { "filter_type": "peak", "freq": 200.0, "q": 1.8, "db_gain": -3.0 },
              { "filter_type": "peak", "freq": 4000.0, "q": 2.0, "db_gain": 1.5 }
            ]
          }
        }
      ],
      "drivers": null
    },
    "right": {
      "channel": "right",
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": { "gain_db": -1.2 }
        },
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              { "filter_type": "peak", "freq": 100.0, "q": 2.2, "db_gain": -3.5 },
              { "filter_type": "peak", "freq": 2800.0, "q": 1.6, "db_gain": 1.8 }
            ]
          }
        }
      ],
      "drivers": null
    },
    "surround_left": {
      "channel": "surround_left",
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": { "gain_db": -2.0 }
        },
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              { "filter_type": "peak", "freq": 150.0, "q": 1.5, "db_gain": -2.5 }
            ]
          }
        }
      ],
      "drivers": null
    },
    "surround_right": {
      "channel": "surround_right",
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": { "gain_db": -1.8 }
        },
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              { "filter_type": "peak", "freq": 160.0, "q": 1.5, "db_gain": -2.2 }
            ]
          }
        }
      ],
      "drivers": null
    },
    "lfe": {
      "channel": "lfe",
      "plugins": [
        {
          "plugin_type": "gain",
          "parameters": { "gain_db": -3.0 }
        },
        {
          "plugin_type": "eq",
          "parameters": {
            "filters": [
              { "filter_type": "peak", "freq": 40.0, "q": 3.0, "db_gain": -6.0 },
              { "filter_type": "peak", "freq": 80.0, "q": 2.0, "db_gain": 2.5 }
            ]
          }
        }
      ],
      "drivers": null
    }
  },
  "metadata": {
    "pre_score": 15.5,
    "post_score": 1.2,
    "algorithm": "cobyla",
    "iterations": 10000,
    "timestamp": "2025-01-15T16:00:00Z"
  }
}
```

---

## Processing Order

When implementing the DSP chain, plugins should be applied in the order they appear in the `plugins` array:

1. **For single-driver channels**: Apply plugins sequentially
2. **For multi-driver channels**:
   - Split the input signal to each driver
   - Apply each driver's plugins independently
   - Sum the driver outputs
   - Apply the channel-level plugins to the summed output

### Signal Flow Diagram

```
Single Driver:
  Input → [Gain] → [EQ] → Output

Multi-Driver (2-way):
  Input ─┬→ [Woofer: Gain → Delay → Crossover(low)] ─┐
         │                                            ├→ Sum → [EQ] → Output
         └→ [Tweeter: Gain → Delay → Crossover(high)] ┘
```

---

## Notes

- Gain values near zero (< 0.01 dB) may be omitted from the output
- Delay values near zero (< 0.001 ms) may be omitted from the output
- The `drivers` field is `null` for single-driver speakers
- Filter frequency, Q, and gain values are optimized for the specified sample rate
- The `invert` parameter is only used for DBA rear arrays
