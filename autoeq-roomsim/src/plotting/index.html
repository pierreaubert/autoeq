<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Acoustics Simulator</title>
    <script src="common/plotly.min.js"></script>
    <link rel="stylesheet" href="common/styles.css">
    <script src="common/plots.js"></script>
    <style>
        /* Dark mode overrides and page-specific styles */
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 { color: #fff; font-size: 2em; }
        h2 {
            color: #fff;
            font-size: 1.3em;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        h3 { color: #ddd; }

        .subtitle { color: #aaa; font-size: 0.9em; }

        .main-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0;
        }

        .sidebar-wrapper {
            display: flex;
            flex-direction: row;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 380px;
            padding: 20px;
            transition: width 0.3s, padding 0.3s, opacity 0.3s;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 0;
            padding: 0;
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-toggle {
            width: 24px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 14px;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .sidebar-toggle span {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            white-space: nowrap;
            font-size: 11px;
            letter-spacing: 1px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-collapsible { overflow: hidden; }
        .panel-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-header:hover { opacity: 0.8; }
        .collapse-icon { transition: transform 0.3s; }
        .panel-content {
            max-height: 1000px;
            transition: max-height 0.3s ease-out, padding 0.3s;
            padding-top: 15px;
        }
        .panel-content.collapsed {
            max-height: 0;
            padding-top: 0;
            overflow: hidden;
        }

        .form-group { margin-bottom: 15px; }

        /* Dark mode form controls */
        label {
            font-size: 0.85em;
            color: #bbb;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #667eea;
            background: rgba(0, 0, 0, 0.5);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .input-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Dark mode buttons */
        .btn-primary { width: 100%; justify-content: center; }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }
        .btn-success {
            background: rgba(100, 255, 100, 0.2);
            color: #51cf66;
            border: 1px solid rgba(100, 255, 100, 0.3);
            padding: 6px 10px;
            font-size: 12px;
        }
        .btn-success:hover { background: rgba(100, 255, 100, 0.3); }

        .source-list { max-height: 300px; overflow-y: auto; }
        .source-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .source-name { font-weight: 600; color: #fff; }
        .source-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85em;
            color: #aaa;
        }

        .progress-container { margin-top: 15px; display: none; }
        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            border-radius: 3px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
        .progress-fill.indeterminate {
            width: 30%;
            animation: indeterminate 1.5s ease-in-out infinite;
        }
        @keyframes indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }
        .progress-text {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 8px;
            text-align: center;
        }
        .progress-details {
            font-size: 0.75em;
            color: #888;
            margin-top: 4px;
            text-align: center;
        }

        .results-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .plot-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .plot-container {
            min-height: 400px;
            height: max(400px, 50vh);
        }

        .plot-container-large {
            min-height: 350px;
            height: 350px;
            width: 100%;
        }

        .plot-container-3d {
            min-height: 500px;
            height: max(500px, 60vh);
        }

        .slice-controls {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
        }

        /* Dark mode slider */
        .frequency-slider {
            background: rgba(255, 255, 255, 0.2);
        }

        .frequency-display {
            font-size: 1.2em;
            font-weight: 600;
            color: #667eea;
            text-align: center;
            margin-top: 10px;
        }

        .slices-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .slices-grid > div { width: 100%; }
        .slice-plot-container { width: 100%; }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .badge-primary {
            background: rgba(102, 126, 234, 0.3);
            color: #667eea;
        }
        .badge-success {
            background: rgba(81, 207, 102, 0.3);
            color: #51cf66;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .tab {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Dark mode info cards */
        .info-card {
            background: rgba(0, 0, 0, 0.2);
        }

        #wasmStatus {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            font-size: 0.8em;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .wasm-loading {
            background: rgba(255, 200, 100, 0.2);
            color: #ffc864;
        }
        .wasm-loading .status-dot {
            background: #ffc864;
            animation: pulse 1s infinite;
        }
        .wasm-ready {
            background: rgba(81, 207, 102, 0.2);
            color: #51cf66;
        }
        .wasm-ready .status-dot { background: #51cf66; }
        .wasm-error {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        .wasm-error .status-dot { background: #ff6b6b; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 1fr; }
            .sidebar-wrapper { flex-direction: column; }
            .sidebar { width: 100%; }
            .sidebar.collapsed { width: 100%; height: 0; }
            .sidebar-toggle {
                width: 100%;
                height: 30px;
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
            }
            .sidebar-toggle span {
                writing-mode: horizontal-tb;
                transform: none;
            }
            .slices-grid > div { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>Room Acoustics Simulator</h1>
                    <p class="subtitle">Proudly open source</p>
                </div>
                <div id="wasmStatus" class="wasm-loading">
                    <span class="status-dot"></span>
                    <span>Loading WASM...</span>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Sidebar - Configuration -->
            <div class="sidebar-wrapper">
            <div class="sidebar" id="sidebar">
                <!-- Room Configuration -->
                <div class="panel panel-collapsible">
                    <div class="panel-header" onclick="togglePanel(this)">
                        <h2 style="margin: 0; border: none; padding: 0;">Room Configuration</h2>
                        <span class="collapse-icon">-</span>
                    </div>
                    <div class="panel-content">
                        <div class="form-group">
                            <label>Room Type</label>
                            <select id="roomType" onchange="updateRoomUI()">
                                <option value="rectangular">Rectangular</option>
                                <option value="lshaped">L-Shaped</option>
                            </select>
                        </div>

                        <div id="rectangularConfig">
                            <div class="form-group">
                                <label>Dimensions (m)</label>
                                <div class="input-row">
                                    <div>
                                        <input type="number" id="roomWidth" value="5.0" step="0.1" min="0.5" placeholder="Width">
                                        <small style="color: #666;">Width (X)</small>
                                    </div>
                                    <div>
                                        <input type="number" id="roomDepth" value="4.0" step="0.1" min="0.5" placeholder="Depth">
                                        <small style="color: #666;">Depth (Y)</small>
                                    </div>
                                    <div>
                                        <input type="number" id="roomHeight" value="2.5" step="0.1" min="0.5" placeholder="Height">
                                        <small style="color: #666;">Height (Z)</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="lshapedConfig" class="hidden">
                            <div class="form-group">
                                <label>Main Section (m)</label>
                                <div class="input-row-2">
                                    <div>
                                        <input type="number" id="width1" value="5.0" step="0.1" min="0.5" placeholder="Width 1">
                                        <small style="color: #666;">Width</small>
                                    </div>
                                    <div>
                                        <input type="number" id="depth1" value="3.0" step="0.1" min="0.5" placeholder="Depth 1">
                                        <small style="color: #666;">Depth</small>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Extension Section (m)</label>
                                <div class="input-row-2">
                                    <div>
                                        <input type="number" id="width2" value="3.0" step="0.1" min="0.5" placeholder="Width 2">
                                        <small style="color: #666;">Width</small>
                                    </div>
                                    <div>
                                        <input type="number" id="depth2" value="2.0" step="0.1" min="0.5" placeholder="Depth 2">
                                        <small style="color: #666;">Depth</small>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Height (m)</label>
                                <input type="number" id="lshapedHeight" value="2.5" step="0.1" min="0.5" placeholder="Height">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sources Configuration -->
                <div class="panel panel-collapsible">
                    <div class="panel-header" onclick="togglePanel(this)">
                        <h2 style="margin: 0; border: none; padding: 0;">Sound Sources</h2>
                        <span class="collapse-icon">-</span>
                    </div>
                    <div class="panel-content">
                        <div class="source-list" id="sourceList">
                            <!-- Sources will be added dynamically -->
                        </div>
                        <button class="btn-secondary" style="width: 100%; margin-top: 10px;" onclick="addSource()">
                            + Add Source
                        </button>
                    </div>
                </div>

                <!-- Listening Position -->
                <div class="panel panel-collapsible">
                    <div class="panel-header" onclick="togglePanel(this)">
                        <h2 style="margin: 0; border: none; padding: 0;">Listening Position</h2>
                        <span class="collapse-icon">-</span>
                    </div>
                    <div class="panel-content">
                        <div class="form-group">
                            <label>Position (m)</label>
                            <div class="input-row">
                                <div>
                                    <input type="number" id="lpX" value="2.5" step="0.1" placeholder="X">
                                    <small style="color: #666;">X</small>
                                </div>
                                <div>
                                    <input type="number" id="lpY" value="2.5" step="0.1" placeholder="Y">
                                    <small style="color: #666;">Y</small>
                                </div>
                                <div>
                                    <input type="number" id="lpZ" value="1.2" step="0.1" placeholder="Z">
                                    <small style="color: #666;">Z</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wall Materials -->
                <div class="panel panel-collapsible">
                    <div class="panel-header" onclick="togglePanel(this)">
                        <h2 style="margin: 0; border: none; padding: 0;">Wall Materials</h2>
                        <span class="collapse-icon">+</span>
                    </div>
                    <div class="panel-content collapsed">
                        <div class="form-group">
                            <label>Left Wall (x=0)</label>
                            <select id="materialLeft" class="material-select"></select>
                        </div>
                        <div class="form-group">
                            <label>Right Wall (x=width)</label>
                            <select id="materialRight" class="material-select"></select>
                        </div>
                        <div class="form-group">
                            <label>Front Wall (y=0)</label>
                            <select id="materialFront" class="material-select"></select>
                        </div>
                        <div class="form-group">
                            <label>Back Wall (y=depth)</label>
                            <select id="materialBack" class="material-select"></select>
                        </div>
                        <div class="form-group">
                            <label>Floor (z=0)</label>
                            <select id="materialFloor" class="material-select"></select>
                        </div>
                        <div class="form-group">
                            <label>Ceiling (z=height)</label>
                            <select id="materialCeiling" class="material-select"></select>
                        </div>
                    </div>
                </div>

                <!-- Frequency & Solver Configuration -->
                <div class="panel panel-collapsible">
                    <div class="panel-header" onclick="togglePanel(this)">
                        <h2 style="margin: 0; border: none; padding: 0;">Simulation Settings</h2>
                        <span class="collapse-icon">-</span>
                    </div>
                    <div class="panel-content">
                        <div class="form-group">
                            <label>Frequency Range (Hz)</label>
                            <div class="input-row-2">
                                <div>
                                    <input type="number" id="minFreq" value="20" min="1" step="1">
                                    <small style="color: #666;">Min</small>
                                </div>
                                <div>
                                    <input type="number" id="maxFreq" value="500" min="1" step="1">
                                    <small style="color: #666;">Max</small>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Number of Frequency Points</label>
                            <input type="number" id="numFreqPoints" value="100" min="10" max="500">
                        </div>
                        <div class="form-group">
                            <label>Solver Method</label>
                            <select id="solverMethod">
                                <option value="direct">Direct (Free-field only)</option>
                                <option value="image-source-1">Image Source (1st order)</option>
                                <option value="image-source-2">Image Source (2nd order)</option>
                                <option value="image-source-3">Image Source (3rd order)</option>
                                <option value="modal">Modal (Standing waves)</option>
                                <option value="hybrid">Hybrid (Modal + ISM)</option>
                                <option value="bem">BEM (Modal + Scattering)</option>
                                <option value="hybrid-bem" selected>Hybrid-BEM (Modal + ISM + Scattering)</option>
                            </select>
                            <small style="color: #666;">BEM modes include scattering from furniture/objects</small>
                        </div>
                        <div class="form-group">
                            <label>Slice Resolution</label>
                            <input type="number" id="sliceResolution" value="40" min="10" max="100">
                            <small style="color: #666;">Higher = more detailed spatial plots</small>
                        </div>
                    </div>
                </div>

                <!-- Run Simulation -->
                <div class="panel">
                    <button class="btn-primary" id="runBtn" onclick="runSimulation()" disabled>
                        <span id="runBtnText">Run Simulation</span>
                    </button>
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">Initializing...</div>
                        <div class="progress-details" id="progressDetails"></div>
                    </div>
                    <div id="statusMessage"></div>
                </div>

                <!-- Load/Save Config -->
                <div class="panel panel-collapsible">
                    <div class="panel-header" onclick="togglePanel(this)">
                        <h2 style="margin: 0; border: none; padding: 0;">Configuration</h2>
                        <span class="collapse-icon">+</span>
                    </div>
                    <div class="panel-content collapsed">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button class="btn-secondary" style="flex: 1;" onclick="exportConfig()">Export JSON</button>
                            <button class="btn-secondary" style="flex: 1;" onclick="document.getElementById('configFileInput').click()">Import JSON</button>
                            <input type="file" id="configFileInput" accept=".json" style="display: none;" onchange="importConfig(event)">
                        </div>
                        <div class="form-group">
                            <label>Presets</label>
                            <select id="presetSelect" onchange="loadPreset()">
                                <option value="">-- Select Preset --</option>
                                <option value="nearfield">Near-field Stereo</option>
                                <option value="home_theater">Home Theater 2.1</option>
                                <option value="surround">5.0 Surround</option>
                                <option value="lshaped">L-Shaped Studio</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
                <span>HIDE CONFIG</span>
            </button>
            </div>

            <!-- Results Area -->
            <div class="results-area">
                <!-- Info Cards -->
                <div class="panel" id="infoPanel" style="display: none;">
                    <h2>Simulation Results</h2>
                    <div class="info-grid" id="infoGrid">
                        <!-- Will be populated after simulation -->
                    </div>
                </div>

                <!-- 3D Room Layout (at top) -->
                <div class="plot-panel" id="room3DPanel" style="display: none;">
                    <h2>3D Room Layout</h2>
                    <div class="plot-container-3d" id="plot3DRoom"></div>
                </div>

                <!-- Frequency Response Plot -->
                <div class="plot-panel" id="freqResponsePanel" style="display: none;">
                    <h2>Frequency Response at Listening Position</h2>
                    <div class="plot-container-large" id="plotFrequencyResponse"></div>
                </div>

                <!-- Spatial Visualization -->
                <div class="plot-panel" id="slicesPanel" style="display: none;">
                    <h2>Spatial Pressure Field</h2>
                    <div class="slice-controls">
                        <label>Select Frequency for Spatial View (computed at ~10 frequencies for performance)</label>
                        <input type="range" class="frequency-slider" id="freqSlider" min="0" max="0" value="0" oninput="handleSliderUpdate()">
                        <div class="frequency-display" id="freqDisplay">- Hz</div>
                    </div>
                    <div class="slices-grid">
                        <div>
                            <h3>Horizontal Slice (XY at listening height)</h3>
                            <div class="slice-plot-container" id="plotHorizontalSlice"></div>
                        </div>
                        <div>
                            <h3>Vertical Slice (XZ at listening depth)</h3>
                            <div class="slice-plot-container" id="plotVerticalSlice"></div>
                        </div>
                        <div>
                            <h3>3D Combined View (Orthogonal Slices)</h3>
                            <div class="slice-plot-container" id="plot3DSlices" style="min-height: 600px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import WASM module
        let wasmModule = null;
        let RoomSimulatorWasm = null;
        let currentSimulator = null;
        let currentResults = null;

        // Toggle sidebar visibility
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebarToggle');
            sidebar.classList.toggle('collapsed');
            toggle.querySelector('span').textContent = sidebar.classList.contains('collapsed') ? 'SHOW CONFIG' : 'HIDE CONFIG';
        };

        // Toggle collapsible panels
        window.togglePanel = function(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.collapse-icon');
            content.classList.toggle('collapsed');
            icon.textContent = content.classList.contains('collapsed') ? '+' : '-';
        };

        // Source management
        let sources = [];
        let sourceIdCounter = 0;

        function initDefaultSources() {
            sources = [];
            sourceIdCounter = 0;
            addSource('Left Speaker', 1.5, 0.5, 1.2, 'fullrange', 'omnidirectional');
            addSource('Right Speaker', 3.5, 0.5, 1.2, 'fullrange', 'omnidirectional');
        }

        window.addSource = function(name, x, y, z, crossover, directivity) {
            const id = sourceIdCounter++;
            sources.push({
                id,
                name: name || `Source ${id + 1}`,
                x: x ?? 2.5,
                y: y ?? 0.5,
                z: z ?? 1.2,
                amplitude: 1.0,
                crossover: crossover || 'fullrange',
                crossoverFreq: 80,
                crossoverOrder: 2,
                directivity: directivity || 'omnidirectional'
            });
            renderSourceList();
        };

        window.removeSource = function(id) {
            sources = sources.filter(s => s.id !== id);
            renderSourceList();
        };

        function renderSourceList() {
            const container = document.getElementById('sourceList');
            container.innerHTML = sources.map(s => `
                <div class="source-item">
                    <div class="source-header">
                        <input type="text" class="source-name" value="${s.name}"
                            onchange="updateSourceField(${s.id}, 'name', this.value)"
                            style="background: transparent; border: none; color: #fff; font-weight: 600; width: 150px;">
                        <button class="btn-danger" onclick="removeSource(${s.id})">Remove</button>
                    </div>
                    <div class="source-details">
                        <div>
                            <label>X (m)</label>
                            <input type="number" value="${s.x}" step="0.1"
                                onchange="updateSourceField(${s.id}, 'x', parseFloat(this.value))">
                        </div>
                        <div>
                            <label>Y (m)</label>
                            <input type="number" value="${s.y}" step="0.1"
                                onchange="updateSourceField(${s.id}, 'y', parseFloat(this.value))">
                        </div>
                        <div>
                            <label>Z (m)</label>
                            <input type="number" value="${s.z}" step="0.1"
                                onchange="updateSourceField(${s.id}, 'z', parseFloat(this.value))">
                        </div>
                        <div>
                            <label>Crossover</label>
                            <select onchange="updateSourceField(${s.id}, 'crossover', this.value)">
                                <option value="fullrange" ${s.crossover === 'fullrange' ? 'selected' : ''}>Full Range</option>
                                <option value="lowpass" ${s.crossover === 'lowpass' ? 'selected' : ''}>Low Pass</option>
                                <option value="highpass" ${s.crossover === 'highpass' ? 'selected' : ''}>High Pass</option>
                            </select>
                        </div>
                        ${s.crossover !== 'fullrange' ? `
                            <div>
                                <label>Freq (Hz)</label>
                                <input type="number" value="${s.crossoverFreq}" step="10" min="20" max="1000"
                                    onchange="updateSourceField(${s.id}, 'crossoverFreq', parseFloat(this.value))">
                            </div>
                            <div>
                                <label>Order</label>
                                <select onchange="updateSourceField(${s.id}, 'crossoverOrder', parseInt(this.value))">
                                    <option value="2" ${s.crossoverOrder === 2 ? 'selected' : ''}>2nd</option>
                                    <option value="4" ${s.crossoverOrder === 4 ? 'selected' : ''}>4th</option>
                                    <option value="6" ${s.crossoverOrder === 6 ? 'selected' : ''}>6th</option>
                                </select>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        window.updateSourceField = function(id, field, value) {
            const source = sources.find(s => s.id === id);
            if (source) {
                source[field] = value;
                if (field === 'crossover') {
                    renderSourceList();
                }
            }
        };

        // Room UI updates
        window.updateRoomUI = function() {
            const roomType = document.getElementById('roomType').value;
            document.getElementById('rectangularConfig').classList.toggle('hidden', roomType !== 'rectangular');
            document.getElementById('lshapedConfig').classList.toggle('hidden', roomType !== 'lshaped');
        };

        // Wall material presets
        let materialPresets = [];

        function initMaterialSelectors() {
            if (!wasmModule || !wasmModule.get_material_presets) {
                console.warn('get_material_presets not available in WASM module');
                return;
            }

            try {
                const presetsJson = wasmModule.get_material_presets();
                materialPresets = JSON.parse(presetsJson);
                console.log('Loaded material presets:', materialPresets.length);

                const selectors = ['materialLeft', 'materialRight', 'materialFront', 'materialBack', 'materialFloor', 'materialCeiling'];
                const defaults = {
                    materialLeft: 'plaster',
                    materialRight: 'plaster',
                    materialFront: 'plaster',
                    materialBack: 'plaster',
                    materialFloor: 'hardwood',
                    materialCeiling: 'plaster'
                };

                selectors.forEach(id => {
                    const select = document.getElementById(id);
                    select.innerHTML = materialPresets.map(p =>
                        `<option value="${p.id}" ${p.id === defaults[id] ? 'selected' : ''}>${p.name}</option>`
                    ).join('');
                });
            } catch (e) {
                console.error('Failed to load material presets:', e);
            }
        }

        function getMaterialConfig(selectId) {
            const value = document.getElementById(selectId).value;
            return { type: 'preset', name: value };
        }

        // Build configuration object
        function buildConfig() {
            const roomType = document.getElementById('roomType').value;
            let room;

            if (roomType === 'rectangular') {
                room = {
                    type: 'rectangular',
                    width: parseFloat(document.getElementById('roomWidth').value),
                    depth: parseFloat(document.getElementById('roomDepth').value),
                    height: parseFloat(document.getElementById('roomHeight').value)
                };
            } else {
                room = {
                    type: 'lshaped',
                    width1: parseFloat(document.getElementById('width1').value),
                    depth1: parseFloat(document.getElementById('depth1').value),
                    width2: parseFloat(document.getElementById('width2').value),
                    depth2: parseFloat(document.getElementById('depth2').value),
                    height: parseFloat(document.getElementById('lshapedHeight').value)
                };
            }

            const configSources = sources.map(s => {
                let crossover = { type: 'fullrange' };
                if (s.crossover === 'lowpass') {
                    crossover = { type: 'lowpass', cutoff_freq: s.crossoverFreq, order: s.crossoverOrder };
                } else if (s.crossover === 'highpass') {
                    crossover = { type: 'highpass', cutoff_freq: s.crossoverFreq, order: s.crossoverOrder };
                }

                return {
                    name: s.name,
                    position: { x: s.x, y: s.y, z: s.z },
                    amplitude: s.amplitude,
                    directivity: { type: s.directivity },
                    crossover
                };
            });

            return {
                room,
                sources: configSources,
                listening_positions: [{
                    x: parseFloat(document.getElementById('lpX').value),
                    y: parseFloat(document.getElementById('lpY').value),
                    z: parseFloat(document.getElementById('lpZ').value)
                }],
                frequencies: {
                    min_freq: parseFloat(document.getElementById('minFreq').value),
                    max_freq: parseFloat(document.getElementById('maxFreq').value),
                    num_points: parseInt(document.getElementById('numFreqPoints').value),
                    spacing: 'logarithmic'
                },
                solver: {
                    method: document.getElementById('solverMethod').value,
                    speed_of_sound: 343.0
                },
                visualization: {
                    generate_slices: true,
                    slice_resolution: parseInt(document.getElementById('sliceResolution').value),
                    slice_frequency_indices: Array.from({length: parseInt(document.getElementById('numFreqPoints').value)}, (_, i) => i)
                },
                wall_materials: {
                    left: getMaterialConfig('materialLeft'),
                    right: getMaterialConfig('materialRight'),
                    front: getMaterialConfig('materialFront'),
                    back: getMaterialConfig('materialBack'),
                    floor: getMaterialConfig('materialFloor'),
                    ceiling: getMaterialConfig('materialCeiling')
                },
                metadata: {
                    description: 'WASM Room Simulation',
                    author: 'Room Simulator WASM',
                    date: new Date().toISOString().split('T')[0]
                }
            };
        }

        // Run simulation
        window.runSimulation = async function() {
            if (!wasmModule) {
                showStatus('WASM module not loaded', 'error');
                return;
            }

            const runBtn = document.getElementById('runBtn');
            const runBtnText = document.getElementById('runBtnText');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressDetails = document.getElementById('progressDetails');

            runBtn.disabled = true;
            runBtnText.textContent = 'Running...';
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressFill.classList.remove('indeterminate');
            progressText.textContent = 'Building configuration...';
            progressDetails.textContent = '';

            try {
                const config = buildConfig();
                const configJson = JSON.stringify(config);

                // Show solver info
                const solverMethod = config.solver.method;
                const numFreqs = config.frequencies.num_points;
                const resolution = config.visualization.slice_resolution;
                const solverNames = {
                    'direct': 'Direct (free-field)',
                    'image-source-1': 'Image Source (1st order)',
                    'image-source-2': 'Image Source (2nd order)',
                    'image-source-3': 'Image Source (3rd order)',
                    'modal': 'Modal Analysis',
                    'hybrid': 'Hybrid (Modal + ISM)'
                };

                progressText.textContent = 'Validating configuration...';
                progressFill.style.width = '10%';
                progressDetails.textContent = `Solver: ${solverNames[solverMethod] || solverMethod}`;

                const validationResult = JSON.parse(wasmModule.validate_config(configJson));
                if (!validationResult.valid) {
                    const errors = validationResult.error || validationResult.warnings.join(', ');
                    showStatus(`Configuration error: ${errors}`, 'error');
                    return;
                }

                progressText.textContent = 'Creating simulator...';
                progressFill.style.width = '20%';

                currentSimulator = new wasmModule.RoomSimulatorWasm(configJson);

                // Switch to indeterminate progress for the main simulation
                progressText.textContent = 'Computing frequency response...';
                progressFill.style.width = '30%';
                progressFill.classList.add('indeterminate');
                progressDetails.textContent = `${numFreqs} frequencies × ${resolution}×${resolution} spatial grid`;

                // Use setTimeout to allow UI to update before blocking WASM call
                await new Promise(resolve => setTimeout(resolve, 50));

                const startTime = performance.now();
                const resultsJson = currentSimulator.run_simulation();
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
                currentResults = JSON.parse(resultsJson);

                progressFill.classList.remove('indeterminate');
                progressFill.style.width = '90%';
                progressText.textContent = 'Rendering results...';
                progressDetails.textContent = `Computed in ${elapsed}s`;

                displayResults(currentResults);

                progressFill.style.width = '100%';
                progressText.textContent = 'Complete!';
                showStatus(`Simulation completed in ${elapsed}s`, 'success');

            } catch (error) {
                console.error('Simulation error:', error);
                progressFill.classList.remove('indeterminate');
                showStatus(`Simulation failed: ${error.message || error}`, 'error');
            } finally {
                runBtn.disabled = false;
                runBtnText.textContent = 'Run Simulation';
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }
        };

        // Display simulation results using common plotting functions
        function displayResults(results) {
            console.log('======= SIMULATION RESULTS =======');
            console.log('Full results object:', results);
            console.log('frequencies:', results.frequencies);
            console.log('frequency_response:', results.frequency_response);
            console.log('source_responses:', results.source_responses);
            console.log('Room:', results.room);
            console.log('Sources:', results.sources);
            console.log('Listening position:', results.listening_position);
            console.log('================================');

            // Show info panel
            document.getElementById('infoPanel').style.display = 'block';
            const infoGrid = document.getElementById('infoGrid');

            // Build info cards
            let infoHtml = `
                <div class="info-card">
                    <div class="info-value">${results.room.width.toFixed(1)} x ${results.room.depth.toFixed(1)} x ${results.room.height.toFixed(1)}</div>
                    <div class="info-label">Room (m)</div>
                </div>
                <div class="info-card">
                    <div class="info-value">${results.sources.length}</div>
                    <div class="info-label">Sources</div>
                </div>
                <div class="info-card">
                    <div class="info-value">${results.frequencies.length}</div>
                    <div class="info-label">Frequencies</div>
                </div>
                <div class="info-card">
                    <div class="info-value">${results.solver}</div>
                    <div class="info-label">Solver</div>
                </div>
            `;

            // Add acoustics info if available
            if (results.room_acoustics) {
                const ra = results.room_acoustics;
                infoHtml += `
                    <div class="info-card">
                        <div class="info-value">${ra.rt60_eyring.toFixed(2)}s</div>
                        <div class="info-label">RT60 (Eyring)</div>
                    </div>
                    <div class="info-card">
                        <div class="info-value">${ra.schroeder_frequency.toFixed(0)} Hz</div>
                        <div class="info-label">Schroeder Freq</div>
                    </div>
                    <div class="info-card">
                        <div class="info-value">${ra.critical_distance.toFixed(2)}m</div>
                        <div class="info-label">Critical Distance</div>
                    </div>
                `;
            }

            // Add room modes count if available
            if (results.room_modes && results.room_modes.length > 0) {
                infoHtml += `
                    <div class="info-card">
                        <div class="info-value">${results.room_modes.length}</div>
                        <div class="info-label">Room Modes</div>
                    </div>
                `;
            }

            infoGrid.innerHTML = infoHtml;

            // Plot frequency response using common function
            try {
                console.log('Attempting to plot frequency response...');
                console.log('  frequencies:', results.frequencies?.length, 'points');
                console.log('  frequency_response:', results.frequency_response?.length, 'points');
                console.log('  first few freqs:', results.frequencies?.slice(0, 5));
                console.log('  first few SPLs:', results.frequency_response?.slice(0, 5));
                console.log('  RoomPlots available:', typeof RoomPlots);
                console.log('  plotFrequencyResponse available:', typeof RoomPlots?.plotFrequencyResponse);

                const container = document.getElementById('plotFrequencyResponse');
                console.log('  container element:', container);
                console.log('  container size:', container?.offsetWidth, 'x', container?.offsetHeight);

                document.getElementById('freqResponsePanel').style.display = 'block';

                // Check container size after display
                setTimeout(() => {
                    console.log('  container size (after display):', container?.offsetWidth, 'x', container?.offsetHeight);
                }, 100);

                const plotResult = RoomPlots.plotFrequencyResponse(results, 'plotFrequencyResponse', {
                    darkMode: true,
                    sourceLineDash: 'solid',
                    hideCombined: true
                });
                console.log('  plot result:', plotResult);
            } catch (e) {
                console.error('Error plotting frequency response:', e);
                console.error('  Stack:', e.stack);
            }

            // Plot 3D room using common function
            try {
                document.getElementById('room3DPanel').style.display = 'block';
                RoomPlots.plot3DRoom(results, 'plot3DRoom', {
                    darkMode: true
                });
            } catch (e) {
                console.error('Error plotting 3D room:', e);
            }

            // Plot spatial slices
            try {
                if (results.horizontal_slices && results.horizontal_slices.length > 0 &&
                    results.vertical_slices && results.vertical_slices.length > 0) {
                    document.getElementById('slicesPanel').style.display = 'block';
                    RoomPlots.initSpatialSlices(results, 'freqSlider', 'freqDisplay');
                    handleSliderUpdate();
                }
            } catch (e) {
                console.error('Error plotting spatial slices:', e);
            }
        }

        // Handle frequency slider update
        window.handleSliderUpdate = function() {
            RoomPlots.updateSlicePlots(
                'freqSlider',
                'freqDisplay',
                'plotHorizontalSlice',
                'plotVerticalSlice',
                'plot3DSlices',
                { darkMode: true }
            );
        };

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        // Export/Import configuration
        window.exportConfig = function() {
            const config = buildConfig();
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'room_config.json';
            a.click();
            URL.revokeObjectURL(url);
        };

        window.importConfig = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    applyConfig(config);
                    showStatus('Configuration loaded successfully', 'success');
                } catch (error) {
                    showStatus(`Failed to load configuration: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        };

        function applyConfig(config) {
            // Room
            if (config.room.type === 'rectangular') {
                document.getElementById('roomType').value = 'rectangular';
                document.getElementById('roomWidth').value = config.room.width;
                document.getElementById('roomDepth').value = config.room.depth;
                document.getElementById('roomHeight').value = config.room.height;
            } else if (config.room.type === 'lshaped') {
                document.getElementById('roomType').value = 'lshaped';
                document.getElementById('width1').value = config.room.width1;
                document.getElementById('depth1').value = config.room.depth1;
                document.getElementById('width2').value = config.room.width2;
                document.getElementById('depth2').value = config.room.depth2;
                document.getElementById('lshapedHeight').value = config.room.height;
            }
            updateRoomUI();

            // Sources
            sources = [];
            sourceIdCounter = 0;
            config.sources.forEach(s => {
                const crossover = s.crossover.type;
                addSource(s.name, s.position.x, s.position.y, s.position.z, crossover, s.directivity?.type || 'omnidirectional');
                const lastSource = sources[sources.length - 1];
                if (s.crossover.cutoff_freq) {
                    lastSource.crossoverFreq = s.crossover.cutoff_freq;
                    lastSource.crossoverOrder = s.crossover.order || 2;
                }
            });
            renderSourceList();

            // Listening position
            const lp = config.listening_positions[0];
            document.getElementById('lpX').value = lp.x;
            document.getElementById('lpY').value = lp.y;
            document.getElementById('lpZ').value = lp.z;

            // Frequencies
            document.getElementById('minFreq').value = config.frequencies.min_freq;
            document.getElementById('maxFreq').value = config.frequencies.max_freq;
            document.getElementById('numFreqPoints').value = config.frequencies.num_points;

            // Solver
            document.getElementById('solverMethod').value = config.solver?.method || 'direct';
            document.getElementById('sliceResolution').value = config.visualization?.slice_resolution || 40;

            // Wall materials
            if (config.wall_materials) {
                const setMaterial = (id, mat) => {
                    if (mat && mat.name) {
                        document.getElementById(id).value = mat.name;
                    }
                };
                setMaterial('materialLeft', config.wall_materials.left);
                setMaterial('materialRight', config.wall_materials.right);
                setMaterial('materialFront', config.wall_materials.front);
                setMaterial('materialBack', config.wall_materials.back);
                setMaterial('materialFloor', config.wall_materials.floor);
                setMaterial('materialCeiling', config.wall_materials.ceiling);
            }
        }

        // Presets
        window.loadPreset = function() {
            const preset = document.getElementById('presetSelect').value;
            if (!preset) return;

            const presets = {
                nearfield: {
                    room: { type: 'rectangular', width: 3.5, depth: 3.0, height: 2.4 },
                    sources: [
                        { name: 'Left Speaker', position: { x: 0.9, y: 0.5, z: 1.0 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'fullrange' } },
                        { name: 'Right Speaker', position: { x: 2.6, y: 0.5, z: 1.0 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'fullrange' } }
                    ],
                    listening_positions: [{ x: 1.75, y: 2.0, z: 1.0 }],
                    frequencies: { min_freq: 30, max_freq: 500, num_points: 100, spacing: 'logarithmic' },
                    solver: { method: 'direct' },
                    visualization: { generate_slices: true, slice_resolution: 40 }
                },
                home_theater: {
                    room: { type: 'rectangular', width: 6.0, depth: 5.0, height: 2.5 },
                    sources: [
                        { name: 'Left Main', position: { x: 1.0, y: 0.5, z: 1.0 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'highpass', cutoff_freq: 80, order: 4 } },
                        { name: 'Right Main', position: { x: 5.0, y: 0.5, z: 1.0 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'highpass', cutoff_freq: 80, order: 4 } },
                        { name: 'Subwoofer', position: { x: 0.3, y: 0.3, z: 0.2 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'lowpass', cutoff_freq: 80, order: 4 } }
                    ],
                    listening_positions: [{ x: 3.0, y: 3.5, z: 1.1 }],
                    frequencies: { min_freq: 20, max_freq: 300, num_points: 100, spacing: 'logarithmic' },
                    solver: { method: 'direct' },
                    visualization: { generate_slices: true, slice_resolution: 40 }
                },
                surround: {
                    room: { type: 'rectangular', width: 7.0, depth: 6.0, height: 2.7 },
                    sources: [
                        { name: 'Front Left', position: { x: 1.0, y: 0.5, z: 1.2 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'fullrange' } },
                        { name: 'Center', position: { x: 3.5, y: 0.3, z: 1.0 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'fullrange' } },
                        { name: 'Front Right', position: { x: 6.0, y: 0.5, z: 1.2 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'fullrange' } },
                        { name: 'Surround Left', position: { x: 0.5, y: 4.5, z: 1.5 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'fullrange' } },
                        { name: 'Surround Right', position: { x: 6.5, y: 4.5, z: 1.5 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'fullrange' } }
                    ],
                    listening_positions: [{ x: 3.5, y: 4.0, z: 1.1 }],
                    frequencies: { min_freq: 30, max_freq: 400, num_points: 100, spacing: 'logarithmic' },
                    solver: { method: 'direct' },
                    visualization: { generate_slices: true, slice_resolution: 40 }
                },
                lshaped: {
                    room: { type: 'lshaped', width1: 6.0, depth1: 4.0, width2: 3.0, depth2: 3.0, height: 2.5 },
                    sources: [
                        { name: 'Left Speaker', position: { x: 1.0, y: 0.5, z: 1.0 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'fullrange' } },
                        { name: 'Right Speaker', position: { x: 5.0, y: 0.5, z: 1.0 }, amplitude: 1.0, directivity: { type: 'omnidirectional' }, crossover: { type: 'fullrange' } }
                    ],
                    listening_positions: [{ x: 3.0, y: 2.5, z: 1.1 }],
                    frequencies: { min_freq: 30, max_freq: 500, num_points: 100, spacing: 'logarithmic' },
                    solver: { method: 'direct' },
                    visualization: { generate_slices: true, slice_resolution: 40 }
                }
            };

            if (presets[preset]) {
                applyConfig(presets[preset]);
                document.getElementById('presetSelect').value = '';
                showStatus(`Loaded "${preset}" preset`, 'info');
            }
        };

        // Initialize WASM module
        async function initWasm() {
            const statusEl = document.getElementById('wasmStatus');

            try {
                // Try the new package name first, then fall back to old name
                let wasmPath = './pkg/autoeq_roomsim.js';
                let module;

                try {
                    module = await import(wasmPath);
                } catch (e) {
                    console.log('Trying legacy WASM path...');
                    wasmPath = './pkg/math_bem_wasm.js';
                    module = await import(wasmPath);
                }

                await module.default();

                wasmModule = module;
                RoomSimulatorWasm = module.RoomSimulatorWasm;

                // Initialize thread pool for parallel execution
                const numThreads = navigator.hardwareConcurrency || 4;
                if (typeof module.initThreadPool === 'function') {
                    try {
                        await module.initThreadPool(numThreads);
                        console.log(`Thread pool initialized with ${numThreads} threads`);
                        statusEl.className = 'wasm-ready';
                        statusEl.innerHTML = `<span class="status-dot"></span><span>WASM Ready (${numThreads} threads)</span>`;
                    } catch (threadError) {
                        console.warn('Thread pool initialization failed (SharedArrayBuffer may not be available):', threadError);
                        console.warn('Falling back to single-threaded execution. For parallel execution, serve with COOP/COEP headers.');
                        statusEl.className = 'wasm-ready';
                        statusEl.innerHTML = '<span class="status-dot"></span><span>WASM Ready (single-threaded)</span>';
                    }
                } else {
                    statusEl.className = 'wasm-ready';
                    statusEl.innerHTML = '<span class="status-dot"></span><span>WASM Ready</span>';
                }

                document.getElementById('runBtn').disabled = false;
                console.log('WASM module loaded successfully from', wasmPath);

                // Populate wall material dropdowns
                initMaterialSelectors();

            } catch (error) {
                console.error('Failed to load WASM module:', error);
                statusEl.className = 'wasm-error';
                statusEl.innerHTML = '<span class="status-dot"></span><span>WASM Error</span>';

                showStatus(`Failed to load WASM module. Make sure to build with: cd autoeq-roomsim && wasm-pack build --target web`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initDefaultSources();
            initWasm();
        });
    </script>
</body>
</html>
