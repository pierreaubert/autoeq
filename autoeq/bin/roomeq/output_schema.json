{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/pierreaubert/autoeq/roomeq/output_schema.json",
  "title": "RoomEQ DSP Chain Output",
  "description": "Output schema for the roomeq room equalization optimizer (AudioEngine-compatible DSP chain)",
  "type": "object",
  "required": ["version", "channels"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Output format version (semantic versioning)",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "channels": {
      "type": "object",
      "description": "Map of channel names to DSP chains",
      "additionalProperties": {
        "$ref": "#/$defs/ChannelDspChain"
      },
      "minProperties": 1
    },
    "metadata": {
      "$ref": "#/$defs/OptimizationMetadata",
      "description": "Optimization metadata"
    }
  },
  "$defs": {
    "CurveData": {
      "type": "object",
      "description": "Frequency response curve data",
      "properties": {
        "freq": {
          "type": "array",
          "description": "Frequency points in Hz",
          "items": {
            "type": "number",
            "minimum": 0
          }
        },
        "spl": {
          "type": "array",
          "description": "Sound Pressure Level in dB (normalized)",
          "items": {
            "type": "number"
          }
        }
      },
      "required": ["freq", "spl"],
      "additionalProperties": false
    },
    "ChannelDspChain": {
      "type": "object",
      "description": "DSP chain for a single channel",
      "required": ["channel", "plugins"],
      "properties": {
        "channel": {
          "type": "string",
          "description": "Channel name"
        },
        "plugins": {
          "type": "array",
          "description": "Ordered list of plugins",
          "items": {
            "$ref": "#/$defs/PluginConfig"
          }
        },
        "drivers": {
          "oneOf": [
            {
              "type": "null"
            },
            {
              "type": "array",
              "description": "Per-driver DSP chains for multi-driver speakers",
              "items": {
                "$ref": "#/$defs/DriverDspChain"
              }
            }
          ]
        },
        "initial_curve": {
          "oneOf": [
            {
              "type": "null"
            },
            {
              "$ref": "#/$defs/CurveData",
              "description": "Initial frequency response curve before optimization (normalized)"
            }
          ]
        },
        "final_curve": {
          "oneOf": [
            {
              "type": "null"
            },
            {
              "$ref": "#/$defs/CurveData",
              "description": "Final frequency response curve after applying correction (normalized)"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "DriverDspChain": {
      "type": "object",
      "description": "DSP chain for an individual driver",
      "required": ["name", "index", "plugins"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Driver name (e.g., 'woofer', 'tweeter', 'midrange')"
        },
        "index": {
          "type": "integer",
          "description": "Driver index (0 = lowest frequency driver)",
          "minimum": 0
        },
        "plugins": {
          "type": "array",
          "description": "Ordered list of plugins for this driver",
          "items": {
            "$ref": "#/$defs/PluginConfig"
          }
        }
      },
      "additionalProperties": false
    },
    "PluginConfig": {
      "type": "object",
      "description": "Plugin configuration wrapper",
      "required": ["plugin_type", "parameters"],
      "properties": {
        "plugin_type": {
          "type": "string",
          "description": "Plugin type identifier",
          "enum": ["gain", "eq", "crossover", "delay", "convolution"]
        },
        "parameters": {
          "description": "Plugin-specific parameters",
          "oneOf": [
            {
              "$ref": "#/$defs/GainParameters"
            },
            {
              "$ref": "#/$defs/EqParameters"
            },
            {
              "$ref": "#/$defs/CrossoverParameters"
            },
            {
              "$ref": "#/$defs/DelayParameters"
            },
            {
              "$ref": "#/$defs/ConvolutionParameters"
            }
          ]
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "plugin_type": { "const": "gain" } }
          },
          "then": {
            "properties": {
              "parameters": { "$ref": "#/$defs/GainParameters" }
            }
          }
        },
        {
          "if": {
            "properties": { "plugin_type": { "const": "eq" } }
          },
          "then": {
            "properties": {
              "parameters": { "$ref": "#/$defs/EqParameters" }
            }
          }
        },
        {
          "if": {
            "properties": { "plugin_type": { "const": "crossover" } }
          },
          "then": {
            "properties": {
              "parameters": { "$ref": "#/$defs/CrossoverParameters" }
            }
          }
        },
        {
          "if": {
            "properties": { "plugin_type": { "const": "delay" } }
          },
          "then": {
            "properties": {
              "parameters": { "$ref": "#/$defs/DelayParameters" }
            }
          }
        },
        {
          "if": {
            "properties": { "plugin_type": { "const": "convolution" } }
          },
          "then": {
            "properties": {
              "parameters": { "$ref": "#/$defs/ConvolutionParameters" }
            }
          }
        }
      ],
      "additionalProperties": false
    },
    "GainParameters": {
      "type": "object",
      "description": "Gain plugin parameters",
      "required": ["gain_db"],
      "properties": {
        "gain_db": {
          "type": "number",
          "description": "Gain adjustment in dB (positive = boost, negative = cut)"
        },
        "invert": {
          "type": "boolean",
          "description": "Polarity inversion",
          "default": false
        }
      },
      "additionalProperties": false
    },
    "EqParameters": {
      "type": "object",
      "description": "EQ plugin parameters",
      "required": ["filters"],
      "properties": {
        "filters": {
          "type": "array",
          "description": "Array of filter configurations",
          "items": {
            "$ref": "#/$defs/FilterConfig"
          }
        }
      },
      "additionalProperties": false
    },
    "FilterConfig": {
      "type": "object",
      "description": "Individual EQ filter configuration",
      "required": ["filter_type", "freq", "q", "db_gain"],
      "properties": {
        "filter_type": {
          "type": "string",
          "description": "Filter type",
          "enum": ["peak", "lowshelf", "highshelf"]
        },
        "freq": {
          "type": "number",
          "description": "Center/corner frequency in Hz",
          "minimum": 1,
          "maximum": 48000
        },
        "q": {
          "type": "number",
          "description": "Q factor (higher = narrower bandwidth)",
          "minimum": 0.1,
          "maximum": 50
        },
        "db_gain": {
          "type": "number",
          "description": "Gain adjustment in dB"
        }
      },
      "additionalProperties": false
    },
    "CrossoverParameters": {
      "type": "object",
      "description": "Crossover plugin parameters",
      "required": ["type", "frequency", "output"],
      "properties": {
        "type": {
          "type": "string",
          "description": "Crossover type",
          "enum": ["LR24", "LR48", "Butterworth12", "Butterworth24"]
        },
        "frequency": {
          "type": "number",
          "description": "Crossover frequency in Hz",
          "minimum": 20,
          "maximum": 20000
        },
        "output": {
          "type": "string",
          "description": "Band selection",
          "enum": ["low", "high"]
        }
      },
      "additionalProperties": false
    },
    "DelayParameters": {
      "type": "object",
      "description": "Delay plugin parameters",
      "required": ["delay_ms"],
      "properties": {
        "delay_ms": {
          "type": "number",
          "description": "Delay amount in milliseconds",
          "minimum": 0,
          "maximum": 1000
        }
      },
      "additionalProperties": false
    },
    "ConvolutionParameters": {
      "type": "object",
      "description": "Convolution plugin parameters",
      "required": ["ir_file"],
      "properties": {
        "ir_file": {
          "type": "string",
          "description": "Path to WAV file containing impulse response"
        }
      },
      "additionalProperties": false
    },
    "OptimizationMetadata": {
      "type": "object",
      "description": "Metadata about the optimization process",
      "required": ["pre_score", "post_score", "algorithm", "iterations", "timestamp"],
      "properties": {
        "pre_score": {
          "type": "number",
          "description": "Loss function value before optimization"
        },
        "post_score": {
          "type": "number",
          "description": "Loss function value after optimization (lower is better)"
        },
        "algorithm": {
          "type": "string",
          "description": "Optimization algorithm used"
        },
        "iterations": {
          "type": "integer",
          "description": "Maximum iterations configured",
          "minimum": 0
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp of optimization",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    }
  }
}
